<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Assignment Submission Portal</title>

  <style>
    * { box-sizing: border-box; font-family: "Segoe UI", sans-serif; }
    body { margin: 0; background: linear-gradient(135deg, #f7f7f7, #e6dcc8); color: #333; }

    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 40px; background: rgba(255,255,255,0.9); border-bottom: 1px solid #ddd;
    }
    .logo { width: 60px; height: auto; }
    .header-text { text-align: center; }
    .header-text h1 { margin: 0; font-size: 22px; font-weight: 600; }
    .header-text h3 { margin: 5px 0; font-weight: 500; }
    .header-text p { margin: 0; font-style: italic; font-size: 14px; }

    .container {
      max-width: 600px; margin: 40px auto; background: rgba(255,255,255,0.95);
      padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .form-group { margin-bottom: 18px; }
    label { display: block; margin-bottom: 6px; font-weight: 500; }
    input, select { width: 100%; padding: 11px; border-radius: 6px; border: 1px solid #ccc; font-size: 14px; }
    input[type="file"] { padding: 8px; }
    .submit-btn {
      width: 100%; padding: 13px; background: #c7b89b; border: none; border-radius: 30px;
      font-size: 16px; cursor: pointer; transition: 0.3s;
    }
    .submit-btn:hover { background: #b6a784; }
    .submit-btn:disabled { opacity: 0.6; cursor: not-allowed; }

    .modal {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45);
      justify-content: center; align-items: center; z-index: 1000;
    }
    .modal-content {
      background: #fff; padding: 25px; border-radius: 10px; width: 90%; max-width: 420px; text-align: center;
    }
    .modal-content h3 { margin-top: 0; }
    .modal-content input { margin-top: 15px; }
    .modal-actions { display: flex; justify-content: space-between; margin-top: 20px; }
    .modal-actions button { padding: 10px 22px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .cancel-btn { background: #ccc; }
    .proceed-btn { background: #c7b89b; }

    .message { margin-top: 15px; font-size: 14px; text-align: center; }
    .error { color: #c0392b; }
    .success { color: #2e7d32; }
    .download-link { margin-top: 10px; display: block; color: #2e7d32; text-decoration: underline; }
  </style>
</head>
<body>

<header>
  <img src="logo-left.png" class="logo" alt="School Logo">
  <div class="header-text">
    <h1>Owu College of Management Technology</h1>
    <h3>ICT Department</h3>
    <p>Assignment Submission Portal</p>
  </div>
  <img src="logo-right.png" class="logo" alt="School Logo">
</header>

<main class="container">
  <form id="assignmentForm">
    <div class="form-group">
      <label>Full Name</label>
      <input type="text" name="name" required>
    </div>

    <div class="form-group">
      <label>Department</label>
      <input type="text" name="department" required>
    </div>

    <div class="form-group">
      <label>Course</label>
      <select name="course" required>
        <option value="">Select course</option>
        <option>CSC101</option>
        <option>ICT202</option>
        <option>BUS305</option>
      </select>
    </div>

    <div class="form-group">
      <label>Phone Number</label>
      <input type="tel" name="phone" required>
    </div>

    <div class="form-group">
      <label>Email Address</label>
      <input type="email" name="email" required>
    </div>

    <div class="form-group">
      <label>Upload Assignment</label>
      <input type="file" name="file" accept=".doc,.docx,.xls,.xlsx,.ppt,.pptx,.pdf" required>
    </div>

    <button class="submit-btn" type="submit">Submit Assignment</button>
    <div class="message" id="message"></div>
    <a id="downloadLink" class="download-link" style="display:none" target="_blank">Download Submitted File</a>
  </form>
</main>

<div class="modal" id="tokenModal">
  <div class="modal-content">
    <h3>Submission Token</h3>
    <p>Enter your assignment submission token</p>
    <input type="text" id="tokenInput" placeholder="e.g. ICT-XYZ-123">
    <div class="modal-actions">
      <button class="cancel-btn" id="cancelBtn">Cancel</button>
      <button class="proceed-btn" id="proceedBtn">Proceed</button>
    </div>
  </div>
</div>

<script>
const BACKEND_URL = "https://assignment-pd4v.onrender.com";

const form = document.getElementById("assignmentForm");
const modal = document.getElementById("tokenModal");
const cancelBtn = document.getElementById("cancelBtn");
const proceedBtn = document.getElementById("proceedBtn");
const message = document.getElementById("message");
const tokenInput = document.getElementById("tokenInput");
const downloadLink = document.getElementById("downloadLink");

let formDataCache;

// Open modal on submit
form.addEventListener("submit", e => {
  e.preventDefault();
  message.textContent = "";
  formDataCache = new FormData(form);
  modal.style.display = "flex";
});

// Cancel token modal
cancelBtn.addEventListener("click", () => {
  modal.style.display = "none";
  tokenInput.value = "";
});

// Proceed with token validation and submission
proceedBtn.addEventListener("click", async () => {
  const token = tokenInput.value.trim();
  if (!token) return alert("Please enter a token");

  proceedBtn.disabled = true;
  proceedBtn.textContent = "Validating...";

  try {
    // Validate token
    const tokenRes = await fetch(`${BACKEND_URL}/api/tokens/validate`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ token })
    });

    const tokenData = await tokenRes.json();
    if (!tokenRes.ok) throw new Error(tokenData.message);

    formDataCache.append("token", token);

    // Submit assignment
    const submitRes = await fetch(`${BACKEND_URL}/api/submissions`, {
      method: "POST",
      body: formDataCache
    });

    const submitData = await submitRes.json();
    if (!submitRes.ok) throw new Error(submitData.message);

    modal.style.display = "none";
    form.reset();
    tokenInput.value = "";

    message.textContent = "Assignment submitted successfully.";
    message.className = "message success";

    if (submitData.fileUrl) {
      downloadLink.href = submitData.fileUrl;
      downloadLink.style.display = "block";
    }

  } catch (err) {
    message.textContent = err.message || "Submission failed.";
    message.className = "message error";
    downloadLink.style.display = "none";
  } finally {
    proceedBtn.disabled = false;
    proceedBtn.textContent = "Proceed";
  }
});
</script>
</body>
</html>